# Fukuoka Flight Tracker - 用户需求文档

> 本文档记录客户所有要求，按时间线追踪变更过程
> Claude 修改代码前必读此文件

---

## 需求时间线

| 时间 | 需求内容 | 状态 | 来源 | 备注 |
|------|----------|------|------|------|
| 2026-02-27 09:15 | 显示航班计划到达/出发时间（真实时刻表数据） | ✅ 已完成 | 用户 | 使用 AeroDataBox API |
| 2026-02-27 | 航班数量显示 **10 个**，不是 20 | ✅ 已完成 | 用户 | `.slice(0, 10)` |
| 2026-02-27 | 航班列表正确显示机场名、航空公司名、国家信息 | ✅ 已完成 | 用户 | AIRLINES/AIRPORTS_NAME/COUNTRY 映射 |
| 2026-02-27 | 地图上显示飞机位置 | ✅ 已完成 | 用户 | adsb.lol API |
| 2026-02-27 19:30 | 飞机颜色匹配：到达=青色，出发=橙色 | ✅ 已完成 | 用户 | 添加IATA→ICAO映射表解决 |
| 2026-02-27 续 | 航班信息显示格式：航班号（目的地/出发地 国家）航空公司 | ✅ 已完成 | 用户 | 添加COUNTRY_BY_AIRPORT映射表 |
| 2026-02-27 续 | 航班排序：当前时间附近的航班排在第3位，特殊高亮 | ✅ 已完成 | 用户 | 类似机场大屏显示逻辑 |

---

## 关键参数（不可擅自修改）

| 参数名 | 值 | 确认时间 | 确认人 |
|--------|-----|----------|--------|
| 航班显示数量 | 10 | 2026-02-27 | 用户 |
| 福冈机场坐标 | 33.5859, 130.451 | 初始设定 | 系统 |
| 覆盖范围 | 100km | 初始设定 | 系统 |
| 位置刷新间隔 | 45秒 | 初始设定 | 系统 |
| 时刻表刷新间隔 | 5分钟 | 初始设定 | 系统 |

---

## 功能清单

### 核心功能
- [x] 实时飞机位置追踪（adsb.lol API）
- [x] 航班时刻表显示（AeroDataBox API）
- [x] 到达航班列表（前10个）
- [x] 出发航班列表（前10个）
- [x] 响应式设计（桌面/移动端）
- [x] 飞机颜色根据到达/出发区分

### 数据源
- [x] adsb.lol - 实时飞机位置
- [x] AeroDataBox - 航班时刻表
- [x] HexDB.io - 航线信息（备用）

### UI/UX
- [x] 地图显示飞机位置和轨迹
- [x] 航班列表显示机场名、航空公司名
- [x] 国家旗帜/标识
- [x] 飞机图标颜色区分（到达=青色，出发=橙色）

---

## 禁止修改项

以下内容未经用户明确同意，禁止修改：

1. **航班显示数量**：必须是 10 个，不是 20
2. **机场坐标配置**：福冈机场坐标不可更改
3. **API 数据源选择**：adsb.lol + AeroDataBox
4. **航空公司/机场/国家名称映射数据**：AIRLINES/AIRPORTS_NAME/COUNTRY_BY_ICAO_PREFIX

---

## 变更历史

### 2026-02-27 17:30 - FlightList 格式修复
- **变更内容**：恢复 FlightList.tsx 到 3a8a0c2 版本
- **原因**：航班列表格式异常，显示为错误格式
- **影响范围**：FlightList.tsx
- **用户确认**：是

### 2026-02-27 18:52 - 添加截图自检规范
- **变更内容**：在项目 CLAUDE.md 添加截图自检规范
- **原因**：Claude 截图看到"0架飞机"却没有追问原因
- **影响范围**：项目规范文档
- **用户确认**：是

### 2026-02-27 19:30 - 修复飞机颜色匹配问题
- **问题**：所有飞机显示灰色，不区分到达/出发
- **根因**：IATA代码（JL310）与ICAO代码（JAL310）不匹配
- **状态**：✅ 已完成
- **解决方案**：
  - 在 MapContainer.tsx 添加 IATA→ICAO 航空公司代码映射表（约60家常见航空公司）
  - 新增 `convertIataToIcao()` 函数进行代码转换
  - 修改航班匹配逻辑使用 ICAO 格式

### 2026-02-27 11:05 - 修复东京多机场时刻表获取
- **问题**：东京机场35架飞机追踪正常，但到达/出发航班显示0
- **根因**：`iata: "HND/NRT"` 格式无效，AeroDataBox API不识别
- **状态**：✅ 已完成
- **解决方案**：
  - 修改 FlightContext.tsx，对于有子机场的区域并行获取每个子机场时刻表并合并
  - 增加API超时到60s应对Render冷启动

### 2026-02-27 续会话 - 航班信息格式增强
- **需求**：航班信息显示格式：航班号（目的地/出发地 国家）航空公司
- **状态**：✅ 已完成
- **解决方案**：
  - 在 FlightList.tsx 添加 COUNTRY_BY_AIRPORT 映射表（约100个常用机场）
  - 新增 `getCountryByAirport()` 函数，支持中日英三语
  - 修改航班显示逻辑，在机场名后添加国家

### 2026-02-27 续会话 - 航班排序逻辑优化
- **需求**：类似机场大屏，当前时间附近的航班排在第3位，特殊高亮
- **状态**：✅ 已完成
- **解决方案**：
  - 修改 sortedFlights 计算逻辑，将当前时间最近的航班放在第3位（索引2）
  - 前面显示2个已过去的航班，后面显示即将到来的航班
  - nextFlightIndex 航班特殊高亮（脉冲动画边框）

---

## 技术约束

### 数据格式问题（已诊断）
- **adsb.lol callsign**：ICAO 格式，如 "JAL310"、"ANA586"
- **AeroDataBox flightNumber**：IATA 格式，如 "JL 310"、"NH 586"
- **解决方案**：需要 IATA→ICAO 航空公司代码映射表

### API 限制
- AeroDataBox：免费版 500次/月
- adsb.lol：无限制

---

*此文档由 Claude 创建并维护，用户需求变更时必须更新*
